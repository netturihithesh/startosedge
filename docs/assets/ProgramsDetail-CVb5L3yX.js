import{u as Z,r as o,n as ee,a as te,f as re,h as se,i as L,j as e,q as ae,o as ie,w as ne,p as oe,t as le,v as ce}from"./index-CQK3th8v.js";import{s as c}from"./supabaseClient-Vuw-lFXn.js";import{u as de,T as ue}from"./Toast-FIzOfCZQ.js";const ge=()=>{const g=Z(),[f,P]=o.useState("all"),[C,F]=o.useState([]),{isAdmin:x}=ee(),{toasts:$,success:h,error:n,removeToast:U}=de(),[I,R]=o.useState(!0),[E,S]=o.useState(!1),[B,T]=o.useState([]),[m,W]=o.useState(null),[b,q]=o.useState(""),[y,D]=o.useState(""),[a,N]=o.useState({title:"",description:"",duration:"",price:"",category:"technical",thumbnail_url:"",is_featured:!1}),[j,_]=o.useState(null),[G,M]=o.useState(!0);o.useEffect(()=>{const t=te.onAuthStateChanged(async r=>{if(!r)n("Please log in to view programs."),g("/login");else{try{const s=await re(se(L,"users",r.uid));if(s.exists()){const l=s.data();W(l),T(l.enrolled_programs||[])}}catch(s){console.error("Error fetching user profile:",s)}M(!1),w()}});return()=>t()},[g,n]);const w=async()=>{try{const{data:t,error:r}=await c.from("programs").select("*").order("created_at",{ascending:!1});if(r)throw r;F(t||[])}catch(t){console.error("Error loading programs:",t)}finally{R(!1)}},p=t=>{const r=t.target.type==="checkbox"?t.target.checked:t.target.value;N({...a,[t.target.name]:r})},H=t=>{const r=t.target.files[0];if(r){if(!r.type.startsWith("image/")){n("Please select an image file");return}if(r.size>2*1024*1024){n("Image size should be less than 2MB");return}_(r)}},z=async t=>{const r=t.name.split(".").pop(),s=`${Date.now()}_${Math.random().toString(36).substring(7)}.${r}`,{data:l,error:d}=await c.storage.from("course-videos").upload(s,t,{cacheControl:"3600",upsert:!1});if(d)throw new Error("Image upload failed: "+d.message);const{data:{publicUrl:i}}=c.storage.from("course-videos").getPublicUrl(s);return i},[v,k]=o.useState(null),O=async t=>{t.preventDefault(),S(!0);try{let r=a.thumbnail_url;if(j&&(r=await z(j)),v){const{error:s}=await c.from("programs").update({title:a.title,description:a.description,duration:a.duration,price:a.price,category:a.category,thumbnail_url:r,is_featured:a.is_featured}).eq("id",v.id);if(s)throw s;h("Program updated successfully!")}else{const{error:s}=await c.from("programs").insert([{title:a.title,description:a.description,duration:a.duration,price:a.price,category:a.category,thumbnail_url:r,is_featured:a.is_featured}]);if(s)throw s;h("Program added successfully!")}N({title:"",description:"",duration:"",price:"",category:"technical",thumbnail_url:"",is_featured:!1}),_(null),k(null),w()}catch(r){console.error("Error saving program:",r),n("Failed to save program: "+r.message)}finally{S(!1)}},K=t=>{k(t),N({title:t.title,description:t.description,duration:t.duration,price:t.price,category:t.category,thumbnail_url:t.thumbnail_url,is_featured:t.is_featured}),window.scrollTo({top:0,behavior:"smooth"})},V=()=>{k(null),N({title:"",description:"",duration:"",price:"",category:"technical",thumbnail_url:"",is_featured:!1}),_(null)},J=async t=>{if(window.confirm(`âš ï¸ WARNING: This will PERMANENTLY delete the program, its thumbnail, and ALL associated videos from both the database and storage.

Are you sure you want to proceed?`))try{const r=document.activeElement;r&&(r.disabled=!0,r.innerText="Deleting...");const{data:s}=await c.from("programs").select("thumbnail_url").eq("id",t).single(),{data:l}=await c.from("program_videos").select("video_url").eq("program_id",t);if(s?.thumbnail_url&&s.thumbnail_url.includes("course-videos/")){const i=s.thumbnail_url.split("course-videos/").pop();if(i){const{error:u}=await c.storage.from("course-videos").remove([i]);u&&console.warn("Failed to delete thumbnail:",u)}}if(l&&l.length>0){const i=l.map(u=>!u.video_url||!u.video_url.includes("course-videos/")?null:u.video_url.split("course-videos/").pop()).filter(Boolean);if(i.length>0){const{error:u}=await c.storage.from("course-videos").remove(i);u&&console.warn("Failed to delete videos:",u)}}const{error:d}=await c.from("programs").delete().eq("id",t);if(d)throw d;h("Program and all associated files deleted successfully!"),w()}catch(r){console.error("Error deleting program:",r),n("Failed to delete program: "+r.message);const s=document.activeElement;s&&(s.disabled=!1,s.innerText="Delete")}},Q=async t=>{try{const{error:r}=await c.from("programs").update({is_featured:!t.is_featured}).eq("id",t.id);if(r)throw r;h(`Program ${t.is_featured?"removed from Home Page":"added to Home Page"}`),w()}catch(r){console.error("Error updating program:",r),n("Failed to update program")}},X=async t=>{if(t.preventDefault(),!b||!y){n("Please enter email and select a program.");return}try{const r=ae(ie(L,"users"),ne("email","==",b)),s=await oe(r);if(s.empty){n("User not found! Ask them to sign up first.");return}const l=s.docs[0];await le(l.ref,{enrolled_programs:ce(y)}),h(`âœ… Access granted to ${b}!`),q(""),D(""),b===m.email&&T(d=>[...d,y])}catch(r){console.error("Error granting access:",r),n("Failed to grant access: "+r.message)}},Y=async t=>{if(!m){n("Please update your profile first (Name & Phone required)."),g("/profile");return}if(!m.phone){n("Phone number is required for purchase. Please update your profile."),g("/profile");return}if(!window.confirm(`Confirm purchase request for "${t.title}"? Admin will contact you at ${m.phone}.`))return;const r=`buy-btn-${t.id}`,s=document.getElementById(r),l=s?s.innerText:"ðŸ›’ Buy Now";s&&(s.innerText="â³ Sending...",s.disabled=!0);const d="https://script.google.com/macros/s/AKfycbx3jlCg-oOWDhDaP258SUUDrtbqC6h1kf4WQXqf7s-K-ROj4ZH-hioneCoHfWudMJhT/exec";try{const i=new URLSearchParams;i.append("name",m.name),i.append("email",m.email),i.append("phone",m.phone),i.append("course",t.title),i.append("timestamp",new Date().toLocaleString()),await fetch(d,{method:"POST",body:i,mode:"no-cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),h("Request sent successfully! Admin will verify and grant access shortly.")}catch(i){console.error("Error sending request:",i),n("Failed to send request. Please try again or contact support.")}finally{s&&(s.innerText="âœ… Request Sent",setTimeout(()=>{s.innerText=l,s.disabled=!1},3e3))}},A=f==="all"?C:C.filter(t=>t.category===f);return G?e.jsx("div",{className:"flex-center",style:{height:"100vh"},children:"Loading..."}):e.jsxs("div",{className:"programs-detail-page",children:[$.map(t=>e.jsx(ue,{message:t.message,type:t.type,onClose:()=>U(t.id)},t.id)),e.jsx("section",{className:"programs-detail-hero section",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"programs-detail-hero-content text-center",children:[e.jsxs("h1",{className:"fade-in-up",children:["All Career ",e.jsx("span",{className:"text-gradient",children:"Programs"})]}),e.jsx("p",{className:"hero-description fade-in-up",children:"Choose your path to a successful tech career. Every program is designed to make you industry-ready."})]})})}),x&&e.jsx("section",{className:"section",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"admin-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:"2rem"},children:[e.jsxs("div",{className:"admin-panel card",children:[e.jsx("h3",{children:v?"Edit Program":"Add New Program"}),e.jsxs("form",{onSubmit:O,className:"admin-form",children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Program Title"}),e.jsx("input",{name:"title",value:a.title,onChange:p,required:!0,placeholder:"e.g. Full Stack Development"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Price"}),e.jsx("input",{name:"price",value:a.price,onChange:p,required:!0,placeholder:"e.g. â‚¹20,000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Duration"}),e.jsx("input",{name:"duration",value:a.duration,onChange:p,required:!0,placeholder:"e.g. 6 Months"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Category"}),e.jsxs("select",{name:"category",value:a.category,onChange:p,children:[e.jsx("option",{value:"technical",children:"Technical"}),e.jsx("option",{value:"non-technical",children:"Non-Technical"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Thumbnail Image"}),e.jsx("input",{type:"file",accept:"image/*",onChange:H}),j&&e.jsxs("small",{className:"text-muted",children:["Selected: ",j.name]}),!j&&a.thumbnail_url&&e.jsxs("small",{className:"text-muted",children:["Current: ",e.jsx("a",{href:a.thumbnail_url,target:"_blank",rel:"noreferrer",children:"View Image"})]})]}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",name:"is_featured",checked:a.is_featured,onChange:p}),"Feature on Home Page"]})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{name:"description",value:a.description,onChange:p,required:!0,rows:"3",placeholder:"Describe the program..."})]}),e.jsxs("div",{className:"admin-form-actions",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:E,children:E?"Saving...":v?"Update Program":"Add Program"}),v&&e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:V,children:"Cancel"})]})]})]}),e.jsxs("div",{className:"admin-panel card",style:{height:"fit-content"},children:[e.jsx("h3",{children:"Grant Course Access"}),e.jsx("p",{className:"text-muted",style:{marginBottom:"1rem"},children:"Enter the user's email from the Google Sheet to unlock the course for them."}),e.jsxs("form",{onSubmit:X,className:"admin-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"User Email"}),e.jsx("input",{type:"email",value:b,onChange:t=>q(t.target.value),required:!0,placeholder:"user@example.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Select Program"}),e.jsxs("select",{value:y,onChange:t=>D(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Select Course --"}),C.map(t=>e.jsx("option",{value:t.id,children:t.title},t.id))]})]}),e.jsx("button",{type:"submit",className:"btn btn-success",children:"Grant Access"})]})]})]})})}),e.jsx("section",{className:"filter-section section",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"filter-buttons",children:[e.jsx("button",{className:`filter-btn ${f==="all"?"active":""}`,onClick:()=>P("all"),children:"All"}),e.jsx("button",{className:`filter-btn ${f==="technical"?"active":""}`,onClick:()=>P("technical"),children:"Technical"}),e.jsx("button",{className:`filter-btn ${f==="non-technical"?"active":""}`,onClick:()=>P("non-technical"),children:"Non-Technical"})]})})}),e.jsx("section",{className:"programs-grid-section section",children:e.jsx("div",{className:"container",children:I?e.jsx("p",{className:"text-center",children:"Loading programs..."}):A.length===0?e.jsx("p",{className:"text-center text-muted",children:"No programs found."}):e.jsx("div",{className:"programs-detail-grid",children:A.map(t=>{const r=B.includes(t.id)||x;return e.jsxs("div",{className:`program-detail-card card ${x?"admin-mode":""}`,children:[e.jsxs("div",{className:"program-thumbnail",children:[e.jsx("img",{src:t.thumbnail_url||"https://via.placeholder.com/300x200?text=No+Image",alt:t.title,onError:s=>{s.target.src="https://via.placeholder.com/300x200?text=No+Image"}}),t.is_featured&&e.jsx("span",{className:"featured-badge",children:"Featured"}),e.jsx("span",{className:"category-badge",children:t.category}),x&&e.jsx("button",{className:"edit-btn-pencil",title:"Edit Program",onClick:s=>{s.stopPropagation(),K(t)},children:e.jsx("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",width:"16",height:"16",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})})})]}),e.jsxs("div",{className:"program-content",children:[e.jsx("h3",{children:t.title}),e.jsx("p",{className:"program-description",children:t.description}),e.jsxs("div",{className:"program-meta",children:[e.jsxs("span",{children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"6px"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]}),t.duration]}),e.jsxs("span",{children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"6px"},children:[e.jsx("path",{d:"M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"}),e.jsx("line",{x1:"7",y1:"7",x2:"7.01",y2:"7"})]}),t.price]})]}),r?e.jsx("button",{className:"btn btn-success",onClick:()=>g(`/programs/${t.id}`),children:"Access Course"}):e.jsx("button",{id:`buy-btn-${t.id}`,className:"btn btn-primary",onClick:()=>Y(t),children:"Buy Now"}),x&&e.jsxs("div",{className:"admin-controls",children:[e.jsx("button",{className:`btn btn-sm ${t.is_featured?"btn-warning":"btn-success"}`,onClick:s=>{s.stopPropagation(),Q(t)},children:t.is_featured?"Un-Feature":"Feature"}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:s=>{s.stopPropagation(),J(t.id)},children:"Delete"})]})]})]},t.id)})})})})]})};export{ge as default};
