import{x as P,u as A,n as I,r as i,j as e}from"./index-Du2n7QN6.js";import{s as l}from"./supabaseClient-BNYETCl9.js";import{u as z,T as O}from"./Toast-ighZhsVy.js";const H=()=>{const{id:n}=P(),v=A(),{isAdmin:C}=I(),{toasts:S,success:h,error:a,removeToast:U}=z(),[f,E]=i.useState(null),[g,F]=i.useState([]),[t,x]=i.useState(null),[L,_]=i.useState(!0),[j,b]=i.useState(!1),[d,m]=i.useState({title:"",description:""}),[N,y]=i.useState(null);i.useEffect(()=>{p()},[n]);const p=async()=>{try{const{data:s,error:r}=await l.from("programs").select("*").eq("id",n).single();if(r||!s){a("Course not found"),v("/programs");return}E(s);const{data:o,error:c}=await l.from("program_videos").select("*").eq("program_id",n).order("created_at",{ascending:!0});if(c)throw c;F(o||[]),o&&o.length>0&&x(o[0])}catch(s){console.error("Error loading course:",s),a("Error loading course content")}finally{_(!1)}},D=s=>{const r=s.target.files[0];if(r){if(!r.type.startsWith("video/")){a("Please select a valid video file");return}if(r.size>50*1024*1024){a("Video size must be less than 50MB");return}y(r)}},B=async s=>{const r=s.name.split(".").pop(),o=`videos/${n}/${Date.now()}_${Math.random().toString(36).substring(7)}.${r}`;console.log("Uploading video:",o);const{data:c,error:V}=await l.storage.from("course-videos").upload(o,s,{cacheControl:"3600",upsert:!1});if(V)throw V;const{data:{publicUrl:$}}=l.storage.from("course-videos").getPublicUrl(o);return $},k=async s=>{if(s.preventDefault(),!N){a("Please select a video file to upload");return}b(!0);try{const r=await B(N),{error:o}=await l.from("program_videos").insert([{program_id:n,title:d.title,description:d.description,video_url:r}]);if(o)throw o;h("Video uploaded successfully!"),m({title:"",description:""}),y(null),document.getElementById("video-upload-input").value="",p()}catch(r){console.error("Error adding video:",r),a("Failed to add video: "+r.message)}finally{b(!1)}},q=async s=>{if(window.confirm("Delete this video?"))try{const{error:r}=await l.from("program_videos").delete().eq("id",s);if(r)throw r;h("Video deleted"),p()}catch(r){console.error("Error deleting video:",r),a("Failed to delete video")}},[u,R]=i.useState(null),[T,w]=i.useState(!1);i.useEffect(()=>(t?.video_url&&M(t.video_url),()=>{u&&URL.revokeObjectURL(u)}),[t]);const M=async s=>{w(!0);try{const o=await(await fetch(s)).blob(),c=URL.createObjectURL(o);R(c)}catch(r){console.error("Error loading secure video:",r),a("Failed to load secure video")}finally{w(!1)}};return L?e.jsx("div",{className:"loading-screen",children:"Loading Course..."}):f?e.jsxs("div",{className:"course-viewer-page",children:[S.map(s=>e.jsx(O,{message:s.message,type:s.type,onClose:()=>U(s.id)},s.id)),e.jsxs("div",{className:"course-viewer-container",children:[e.jsxs("div",{className:"course-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("button",{className:"back-btn",onClick:()=>v("/programs"),children:"â† Back"}),e.jsx("h3",{children:f.title})]}),e.jsx("div",{className:"video-list",children:g.length===0?e.jsx("p",{className:"no-videos",children:"No videos yet."}):g.map((s,r)=>e.jsxs("div",{className:`video-item ${t?.id===s.id?"active":""}`,onClick:()=>x(s),children:[e.jsx("span",{className:"video-number",children:r+1}),e.jsxs("div",{className:"video-info",children:[e.jsx("h4",{children:s.title}),e.jsx("span",{className:"video-duration",children:"Watch Now"})]})]},s.id))})]}),e.jsxs("div",{className:"course-main",children:[t?e.jsxs("div",{className:"video-player-wrapper",children:[e.jsx("div",{className:"video-frame",children:T?e.jsxs("div",{className:"video-loading-overlay",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Securing Video Stream..."})]}):e.jsx("video",{controls:!0,controlsList:"nodownload",onContextMenu:s=>s.preventDefault(),playsInline:!0,className:"html5-video-player",src:u,children:"Your browser does not support the video tag."},u)}),e.jsxs("div",{className:"video-details",children:[e.jsx("h2",{children:t.title}),e.jsx("p",{className:"video-description",children:t.description})]})]}):e.jsxs("div",{className:"empty-state",children:[e.jsx("h2",{children:"Select a video to start learning"}),e.jsx("p",{children:"Choose a topic from the sidebar."})]}),C&&e.jsxs("div",{className:"admin-video-panel card",children:[e.jsx("h3",{children:"Upload New Video"}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Video Title"}),e.jsx("input",{value:d.title,onChange:s=>m({...d,title:s.target.value}),required:!0,placeholder:"e.g. Introduction to React"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:d.description,onChange:s=>m({...d,description:s.target.value}),required:!0,placeholder:"Briefly explain what this video covers..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Select Video File (Max 50MB)"}),e.jsx("input",{id:"video-upload-input",type:"file",accept:"video/*",onChange:D,required:!0})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:j,children:j?"Uploading Video...":"Upload Video"})]}),t&&e.jsx("button",{className:"btn btn-secondary mt-2",onClick:()=>q(t.id),style:{marginTop:"1rem"},children:"Delete Current Video"})]})]})]})]}):null};export{H as default};
